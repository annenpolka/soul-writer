# soul-writer 詳細仕様書

## 1. システム概要

soul-writerは、以下の要素から構成される短編小説自動生成システムである。

### 1.1 設計目標

| 目標 | 説明 |
|------|------|
| 文体の忠実度 | 原典（ソウルテキスト）の文体を高精度で再現 |
| 世界観の整合性 | 設定・用語・キャラクターの一貫性を維持 |
| 品質優先 | Token消費よりも品質を重視 |
| 自律運用 | 人間の介入を最小限に抑えた24時間稼働 |

### 1.2 生成物の仕様

- **長さ**: 20,000字以上の短編小説
- **構成**: 複数章（各章3,000〜5,000字程度）
- **出力形式**: Markdown

---

## 2. ソウルテキスト四層構造

ソウルテキストは、原典の「魂」を4つの層で定義する。詳細なフォーマットは[SOUL-FORMAT.md](SOUL-FORMAT.md)を参照。

### 2.1 第一層：憲法（Constitution）

**目的**: 絶対に守るべきルールの定義

- 文のリズム構造（短-短-長-短のパターン）
- 体言止めの使用規則
- 括弧表記（ルビ）の規則
- 禁止語彙
- 「×」の使用規則（殺害行為にのみ使用）

**特徴**: 違反した場合は即座に矯正ループへ

### 2.2 第二層：聖典断片（Scripture Fragments）

**目的**: 文体の「匂い」を伝える参照サンプル

カテゴリ別に原典から抽出した短い断片を格納：

- `opening` - 冒頭/場面導入
- `killing` - 殺害描写
- `introspection` - 内省/独白
- `dialogue` - 対話シーン
- `world_building` - 世界観の織り込み
- `character_voice` - キャラクター固有の語り口

**使用方法**: 生成時にカテゴリに応じた断片をシステムプロンプトに注入

### 2.3 第三層：世界聖書（World Bible）

**目的**: 設定・用語・社会システムの正典

- 技術体系（MR、タグ、推奨事項）
- 社会構造（計画出産、安楽死センター）
- キャラクター設定シート
- 用語集

**使用方法**: 整合性チェックの基準として使用

### 2.4 第四層：反魂（Anti-Soul）

**目的**: 「こう書いてはいけない」の明示的な例

- 過剰な感傷
- 説明的すぎる世界観提示
- キャラクターの「普通化」
- 陳腐な比喩

**収集方法**: 不合格判定された生成物から自動収集

---

## 3. 生成パイプライン

### 3.1 全体フロー

```
┌─────────────┐
│ プロット生成 │  Plotterエージェント
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   章分割    │  テーマ・長さ・構成を決定
└──────┬──────┘
       │
       ▼ (各章について)
┌─────────────────────────────────────┐
│         4人トーナメント              │
│  ┌───────┐ ┌───────┐               │
│  │Writer1│ │Writer2│               │
│  └───┬───┘ └───┬───┘               │
│      └────┬────┘                    │
│           ▼                         │
│      ┌─────────┐                    │
│      │  Judge  │  勝者選出          │
│      └────┬────┘                    │
│           ▼                         │
│  ┌───────┐ ┌───────┐               │
│  │Writer3│ │Writer4│               │
│  └───┬───┘ └───┬───┘               │
│      └────┬────┘                    │
│           ▼                         │
│      ┌─────────┐                    │
│      │  Judge  │  勝者選出          │
│      └────┬────┘                    │
│           ▼                         │
│      ┌─────────┐                    │
│      │ 決勝戦   │  最終勝者決定      │
│      └────┬────┘                    │
└───────────┼─────────────────────────┘
            ▼
┌─────────────────────────────────────┐
│         適合度チェック               │
│  ┌──────────┐                       │
│  │Compliance│  憲法違反チェック     │
│  └────┬─────┘                       │
│       │                             │
│   ┌───┴───┐                         │
│ 合格│     │違反                     │
│   ▼       ▼                         │
│ 出力   矯正ループ → 再評価          │
└─────────────────────────────────────┘
            ▼
┌─────────────────────────────────────┐
│         読者陪審員                   │
│  複数ペルソナによる多角的評価        │
└─────────────────────────────────────┘
            ▼
┌─────────────────────────────────────┐
│         アーカイブ                   │
│  SQLite + 自動学習候補抽出          │
└─────────────────────────────────────┘
```

### 3.2 Plotterエージェント

**入力**:
- ソウルテキスト（テーマ、世界観）
- 生成パラメータ（章数、総文字数の目安）

**出力**:
```json
{
  "title": "物語のタイトル",
  "theme": "中心テーマの説明",
  "chapters": [
    {
      "index": 1,
      "title": "章タイトル",
      "summary": "章の要約",
      "key_events": ["イベント1", "イベント2"],
      "target_length": 4000
    }
  ]
}
```

### 3.3 Writerエージェント

**役割**: プロットと前章の内容に基づいて章を執筆

**パラメータのバリエーション**:

| Writer ID | temperature | top_p | 特性 |
|-----------|-------------|-------|------|
| writer_1 | 0.7 | 0.9 | バランス型 |
| writer_2 | 0.9 | 0.95 | 創造型 |
| writer_3 | 0.5 | 0.8 | 保守型 |
| writer_4 | 0.8 | 0.85 | 中間型 |

**システムプロンプト構成**:
1. 憲法（該当部分）
2. 聖典断片（カテゴリに応じて2-3個）
3. 世界聖書（必要な設定）
4. 反魂（該当カテゴリのBAD例）

### 3.4 Judgeエージェント

**役割**: 2つの生成物を比較し、勝者を選出

**評価基準**:
1. 憲法適合度（禁止語彙、文構造）
2. 聖典断片との類似度
3. 世界観の整合性
4. 反魂との非類似度

**出力**:
```json
{
  "winner": "writer_1",
  "scores": {
    "writer_1": {
      "constitution_compliance": 0.92,
      "style_similarity": 0.85,
      "world_consistency": 0.90,
      "anti_soul_distance": 0.88
    },
    "writer_2": {
      "constitution_compliance": 0.78,
      "style_similarity": 0.82,
      "world_consistency": 0.85,
      "anti_soul_distance": 0.75
    }
  },
  "reason": "writer_1は憲法適合度が高く、特に体言止めの使用が適切"
}
```

### 3.5 Correctorエージェント

**役割**: 不合格となった生成物を矯正

**入力**:
- 不合格の生成物
- 違反箇所のリスト

**動作**:
1. 違反箇所を特定
2. 憲法に沿って修正
3. 最大3回まで矯正ループ

**矯正後の処理**:
- 合格 → 出力
- 3回不合格 → 反魂に追加してスキップ

### 3.6 読者陪審員

**役割**: 複数の読者ペルソナによる多角的評価

**デフォルトペルソナ**:

| ペルソナ | 重視する観点 |
|---------|-------------|
| SF愛好家 | 世界設定の緻密さ、SF的整合性 |
| 文学少女 | 文体の美しさ、心理描写の深さ |
| ライトリーダー | テンポ、読みやすさ |
| 編集者 | 構成、商業的価値 |

**カスタムペルソナ**: ソウルごとに定義可能

---

## 4. 自動学習システム

### 4.1 二段階承認フロー

```
┌─────────────────────────────────────┐
│         生成完了                     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│      スコア判定                      │
│  compliance_score >= 0.85 かつ      │
│  reader_score >= 0.80              │
└──────────────┬──────────────────────┘
               │
       ┌───────┴───────┐
       │               │
   低スコア        高スコア
       │               │
       ▼               ▼
   アーカイブ      候補プールに追加
   （通常保存）    （status: pending）
                       │
                       ▼
              ┌─────────────────┐
              │ 人間レビュー     │
              │ (定期的に実施)   │
              └────────┬────────┘
                       │
               ┌───────┴───────┐
               │               │
           承認             却下
               │               │
               ▼               ▼
          ソウル拡張      候補から削除
          (fragments      (反魂に追加
           に追加)        も検討)
```

### 4.2 候補プールの管理

**保存される情報**:
- 元の生成物ID
- 抽出された断片
- 推奨カテゴリ
- 自動スコア
- 作成日時

**レビューインターフェース**:
- Webダッシュボードで候補一覧を表示
- 断片のプレビュー
- 承認/却下ボタン
- カテゴリの変更

---

## 5. チェックポイントシステム

### 5.1 保存タイミング

- 各章の生成完了時
- トーナメントの各ラウンド完了時
- 矯正ループの各回完了時

### 5.2 チェックポイントの内容

```json
{
  "task_id": "uuid",
  "created_at": "2024-01-01T00:00:00Z",
  "phase": "chapter_generation",
  "progress": {
    "current_chapter": 3,
    "total_chapters": 5,
    "tournament_round": 2
  },
  "state": {
    "plot": { ... },
    "completed_chapters": [ ... ],
    "current_candidates": [ ... ]
  }
}
```

### 5.3 再開処理

1. 未完了タスクを検出
2. 最新チェックポイントを読み込み
3. 該当フェーズから再開

---

## 6. エラーハンドリング

### 6.1 API エラー

| エラー種別 | 対応 |
|-----------|------|
| レート制限 | 指数バックオフでリトライ |
| タイムアウト | 最大3回リトライ後スキップ |
| 無効なレスポンス | JSONパースリトライ、失敗時スキップ |

### 6.2 生成エラー

| エラー種別 | 対応 |
|-----------|------|
| 憲法違反 | 矯正ループ（最大3回） |
| 3回連続不合格 | 反魂に追加してスキップ |
| 文字数不足 | 追加生成を要求 |

---

## 7. Token消費見積もり

### 7.1 1作品あたりの消費

| 処理 | トークン数 |
|------|-----------|
| プロット生成 | ~2K |
| 4作家×執筆（5章） | ~100K |
| トーナメント（15戦） | ~75K |
| 司法審査（5回） | ~50K |
| 矯正（発生時） | ~20K |
| 読者陪審員（4人×5章） | ~80K |
| **合計** | **~300K〜350K/作品** |

### 7.2 日次生成量の目安

120M tokens/day の場合:
- 約340〜400作品/日
- 品質優先のため、実際は200〜300作品程度を想定
